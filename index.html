<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªá Th·ªëng Thi Tr·ª±c Tuy·∫øn</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      /* Login Page & Forms */
      .login-container {
        max-width: 450px;
        margin: 50px auto;
        padding: 40px;
      }

      .login-box {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .login-title {
        text-align: center;
        margin-bottom: 30px;
        color: #333;
        font-size: 1.8em;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 600;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        transition: border 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        transition: transform 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        margin-top: 10px;
      }

      .btn-tertiary {
        background: #00bcd4;
        margin-top: 10px;
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        text-align: center;
      }

      /* General Dashboard & Nav */
      .dashboard {
        padding: 30px;
      }

      .nav-bar {
        background: #f8f9fa;
        padding: 15px 30px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .btn-logout {
        background: #dc3545;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      .btn-small {
        padding: 8px 15px;
        font-size: 0.9em;
        margin-right: 10px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
      }

      .btn-view {
        background: #28a745;
        color: white;
      }

      .btn-delete {
        background: #dc3545;
        color: white;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      /* Folder/Exam List */
      .folder-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }

      .folder-card {
        width: 250px;
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.2s;
        border-left: 5px solid #667eea;
      }

      .folder-card:hover {
        background: #c5e3fe;
        transform: translateY(-2px);
      }

      .exam-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s;
      }

      /* New CSS for Exam Taking UI (Student) */
      .exam-display {
        padding: 40px;
      }

      .question-container {
        display: grid;
        gap: 30px; /* TƒÉng kho·∫£ng c√°ch gi·ªØa c√°c c√¢u h·ªèi */
      }

      .question-item {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .question-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        font-weight: bold;
        font-size: 1.2em;
      }

      .question-image {
        /* S·ª≠a l·ªói c·∫Øt ·∫£nh */
        width: 100%;
        display: block;
        max-height: none; /* B·ªè gi·ªõi h·∫°n chi·ªÅu cao c≈© */
        object-fit: contain; /* ƒê·∫£m b·∫£o to√†n b·ªô ·∫£nh hi·ªÉn th·ªã */
        background: #f5f5f5;
        padding: 20px; /* Th√™m padding ƒë·ªÉ ·∫£nh kh√¥ng b·ªã d√≠nh s√°t */
      }

      .answer-section {
        padding: 20px;
        background: #f8f9fa;
      }

      .answer-options {
        display: grid;
        grid-template-columns: repeat(
          auto-fit,
          minmax(200px, 1fr)
        ); /* 2 c·ªôt tr√™n desktop */
        gap: 15px; /* TƒÉng kho·∫£ng c√°ch gi·ªØa c√°c ƒë√°p √°n */
      }

      .answer-option {
        padding: 15px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px; /* G√≥c bo tr√≤n ƒë·∫πp h∆°n */
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        position: relative;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .answer-option input[type="checkbox"] {
        /* ·∫®n checkbox m·∫∑c ƒë·ªãnh */
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
        margin: 0;
        z-index: 10;
      }

      .answer-option label {
        font-weight: 600;
        color: #333;
        margin-left: 10px;
        cursor: pointer;
        position: relative;
        z-index: 5;
      }

      .answer-option:hover {
        border-color: #667eea;
        background: #f0f0ff;
      }

      .answer-option.selected {
        border-color: #667eea;
        background: #e3f2fd;
        box-shadow: 0 0 0 3px #667eea40; /* Hi·ªáu ·ª©ng n·ªïi b·∫≠t khi ch·ªçn */
      }

      /* Th√™m icon check t√πy ch·ªânh */
      .answer-option::before {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #ccc;
        border-radius: 4px;
        background-color: white;
        transition: all 0.2s;
      }

      .answer-option.selected::before {
        content: "‚úî";
        background-color: #667eea;
        border-color: #667eea;
        color: white;
        text-align: center;
        line-height: 18px;
        font-size: 14px;
      }

      .submit-exam {
        text-align: center;
        margin-top: 30px;
      }

      /* Result View styles retained from previous version */
      .history-card {
        background: #f9f9f9;
        border: 2px solid #00bcd4;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .review-correct {
        border-color: #28a745;
        background: #e6ffe6;
      }
      .review-incorrect {
        border-color: #dc3545;
        background: #ffe6e6;
      }
      .review-unanswered {
        border-color: #ffc107;
        background: #fff8e1;
      }

      .hidden {
        display: none;
      }

      #fileInput {
        display: none;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8em;
        }

        .login-container,
        .student-login {
          padding: 20px;
        }

        .nav-bar {
          flex-direction: column;
          gap: 10px;
        }

        .folder-card {
          width: 100%;
        }

        .answer-options {
          grid-template-columns: 1fr; /* 1 c·ªôt tr√™n mobile */
        }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script>
      const ADMIN_EMAIL = "admin05@gmail.com";
      const ADMIN_PASSWORD = "tuan0112";
      const OPTIONS = ["A", "B", "C", "D"]; // C√°c l·ª±a ch·ªçn ƒë√°p √°n
      const STUDENT_CODE_DEFAULT = "T&Q"; // M√£ thi chung c≈©, gi·ªØ l·∫°i ƒë·ªÉ d·ªÖ ph√¢n bi·ªát v·ªõi ID

      let currentView = "home";
      let folders = []; // Th∆∞ m·ª•c
      let exams = []; // ƒê·ªÅ thi
      let history = []; // L·ªãch s·ª≠ l√†m b√†i
      let students = []; // Danh s√°ch h·ªçc sinh m·ªõi
      let currentExam = null;
      let studentAnswers = {};
      let currentStudent = null; // L∆∞u tr·ªØ th√¥ng tin h·ªçc sinh ƒëang ƒëƒÉng nh·∫≠p
      let currentFolderId = null; // Th∆∞ m·ª•c hi·ªán t·∫°i ƒëang xem (Admin)

      function init() {
        loadFolders();
        loadExams();
        loadHistory();
        loadStudents();
        showHomePage();
      }

      // --- LocalStorage Functions ---
      function loadFolders() {
        const saved = localStorage.getItem("folders");
        if (saved) {
          folders = JSON.parse(saved);
        } else {
          folders = [{ id: "default", name: "Ch∆∞a ph√¢n lo·∫°i" }];
        }
      }

      function saveFolders() {
        localStorage.setItem("folders", JSON.stringify(folders));
      }

      function loadExams() {
        const saved = localStorage.getItem("exams");
        if (saved) {
          exams = JSON.parse(saved);
        }
      }

      function saveExams() {
        localStorage.setItem("exams", JSON.stringify(exams));
      }

      function loadHistory() {
        const saved = localStorage.getItem("examHistory");
        if (saved) {
          history = JSON.parse(saved);
        }
      }

      function saveHistory() {
        localStorage.setItem("examHistory", JSON.stringify(history));
      }

      function loadStudents() {
        const saved = localStorage.getItem("students");
        if (saved) {
          students = JSON.parse(saved);
        }
      }

      function saveStudents() {
        localStorage.setItem("students", JSON.stringify(students));
      }

      // --- General Views ---
      function showHomePage() {
        currentView = "home";
        currentStudent = null;
        currentFolderId = null;
        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>üéì H·ªá Th·ªëng Thi Tr·ª±c Tuy·∫øn</h1>
                        <p>Qu·∫£n l√Ω v√† tham gia k·ª≥ thi tr·ª±c tuy·∫øn</p>
                    </div>
                    <div class="login-container">
                        <div class="login-box">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <button class="btn" onclick="showAdminLogin()">
                                    üë®‚Äçüè´ ƒêƒÉng Nh·∫≠p Gi√°o Vi√™n
                                </button>
                                <button class="btn btn-secondary" onclick="showStudentLogin()">
                                    üë®‚Äçüéì ƒêƒÉng Nh·∫≠p H·ªçc Sinh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      }

      // --- Admin Login & Dashboard ---
      function showAdminLogin() {
        currentView = "admin-login";
        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>üë®‚Äçüè´ ƒêƒÉng Nh·∫≠p Gi√°o Vi√™n</h1>
                    </div>
                    <div class="login-container">
                        <div class="login-box">
                            <h2 class="login-title">ƒêƒÉng Nh·∫≠p</h2>
                            <div id="errorMsg" class="error-message hidden"></div>
                            <form onsubmit="handleAdminLogin(event)">
                                <div class="form-group">
                                    <label>Email:</label>
                                    <input type="email" id="adminEmail" required placeholder="admin05@gmail.com">
                                </div>
                                <div class="form-group">
                                    <label>M·∫≠t kh·∫©u:</label>
                                    <input type="password" id="adminPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <button type="submit" class="btn">ƒêƒÉng Nh·∫≠p</button>
                                <button type="button" class="btn btn-secondary" onclick="showHomePage()">Quay L·∫°i</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
      }

      function handleAdminLogin(e) {
        e.preventDefault();
        const email = document.getElementById("adminEmail").value;
        const password = document.getElementById("adminPassword").value;
        const errorMsg = document.getElementById("errorMsg");

        if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
          showAdminDashboard();
        } else {
          errorMsg.textContent = "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!";
          errorMsg.classList.remove("hidden");
        }
      }

      function showAdminDashboard() {
        currentView = "admin-dashboard";
        currentFolderId = null;
        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>üóÇÔ∏è Qu·∫£n L√Ω H·ªá Th·ªëng</h1>
                    </div>
                    <div class="nav-bar">
                        <div class="user-info">üë®‚Äçüè´ Gi√°o vi√™n: ${ADMIN_EMAIL}</div>
                        <button class="btn-logout" onclick="showHomePage()">ƒêƒÉng Xu·∫•t</button>
                    </div>
                    <div class="dashboard">
                        <div style="display: flex; gap: 10px; margin-bottom: 30px;">
                            <button class="btn-small btn-primary" onclick="showCreateExamForm('default')">
                                ‚ûï Th√™m ƒê·ªÅ M·ªõi
                            </button>
                            <button class="btn-small btn-view" onclick="promptCreateFolder()">
                                üìÇ T·∫°o Th∆∞ M·ª•c M·ªõi
                            </button>
                            <button class="btn-small btn-tertiary" onclick="showStudentManagement()">
                                üßë‚Äçüéì Qu·∫£n L√Ω H·ªçc Sinh (${students.length})
                            </button>
                        </div>
                        
                        <h2 style="margin-bottom: 20px;">üìö Th∆∞ M·ª•c ƒê·ªÅ Thi (${
                          folders.length
                        })</h2>
                        <div class="folder-container">
                            ${folders
                              .map((folder) => {
                                const examCount = exams.filter(
                                  (e) => e.folderId === folder.id
                                ).length;
                                return `
                                        <div class="folder-card" onclick="viewFolder('${
                                          folder.id
                                        }', '${folder.name}')">
                                            <h3>${folder.name}</h3>
                                            <p style="font-size: 0.9em; color: #555;">(${examCount} ƒë·ªÅ thi)</p>
                                            ${
                                              folder.id !== "default"
                                                ? `<button class="btn-small btn-delete" style="width: auto; margin-top: 10px;" onclick="event.stopPropagation(); deleteFolder('${folder.id}')">üóëÔ∏è X√≥a</button>`
                                                : ""
                                            }
                                        </div>
                                    `;
                              })
                              .join("")}
                        </div>
                        
                        <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
                            <h2 style="margin-bottom: 10px;">üìä T·ªïng Quan L·ªãch S·ª≠ Thi</h2>
                            <p>T·ªïng s·ªë b√†i l√†m: <strong>${
                              history.length
                            }</strong></p>
                            <button class="btn-small btn-tertiary" onclick="showAllHistoryAdmin()">Xem T·∫•t C·∫£ B√†i L√†m</button>
                        </div>
                    </div>
                </div>
            `;
      }

      // --- Folder & Exam Management (Admin) ---

      // (Gi·ªØ nguy√™n c√°c h√†m: promptCreateFolder, deleteFolder, viewFolder, showCreateExamForm, handleFileUpload, updatePreview, clearUploadedImages, parseAnswers, saveExam, displayExamList, viewExamAdmin, deleteExam)

      function promptCreateFolder() {
        const folderName = prompt("Nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi:");
        if (folderName && folderName.trim()) {
          const newFolder = {
            id: Date.now().toString(),
            name: folderName.trim(),
          };
          folders.push(newFolder);
          saveFolders();
          showAdminDashboard();
        }
      }

      function deleteFolder(folderId) {
        const folder = folders.find((f) => f.id === folderId);
        if (!folder || folder.id === "default") return;

        const defaultFolder = folders.find((f) => f.id === "default");
        if (!defaultFolder) return;

        const examsInFolder = exams.filter((e) => e.folderId === folderId);
        if (examsInFolder.length > 0) {
          if (
            !confirm(
              `Th∆∞ m·ª•c "${folder.name}" c√≥ ${examsInFolder.length} ƒë·ªÅ thi. B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th∆∞ m·ª•c v√† chuy·ªÉn c√°c ƒë·ªÅ n√†y v·ªÅ "${defaultFolder.name}"?`
            )
          ) {
            return;
          }
          examsInFolder.forEach((e) => (e.folderId = "default"));
          saveExams();
        } else {
          if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th∆∞ m·ª•c "${folder.name}"?`)) {
            return;
          }
        }

        // C·∫≠p nh·∫≠t quy·ªÅn truy c·∫≠p c·ªßa h·ªçc sinh
        students.forEach((student) => {
          student.allowedFolders = student.allowedFolders.filter(
            (id) => id !== folderId
          );
        });
        saveStudents();

        folders = folders.filter((f) => f.id !== folderId);
        saveFolders();
        showAdminDashboard();
      }

      function viewFolder(folderId, folderName) {
        currentFolderId = folderId;
        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>üìÇ ${folderName}</h1>
                        <p>Qu·∫£n l√Ω ƒë·ªÅ thi trong th∆∞ m·ª•c</p>
                    </div>
                    <div class="nav-bar">
                        <button class="btn-logout" onclick="showAdminDashboard()">‚Üê V·ªÅ Th∆∞ M·ª•c</button>
                    </div>
                    <div class="dashboard">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: space-between;">
                            <button class="btn-small btn-primary" style="width: auto;" onclick="showCreateExamForm('${folderId}')">
                                ‚ûï Th√™m ƒê·ªÅ M·ªõi v√†o ${folderName}
                            </button>
                            <div class="search-bar" style="width: 300px;">
                                <input type="text" id="adminSearch" placeholder="T√¨m ki·∫øm ƒë·ªÅ thi..." oninput="displayExamList(event.target.value)">
                            </div>
                        </div>
                        
                        <div class="exam-list">
                            <h2 style="margin-bottom: 20px;">üìù Danh S√°ch ƒê·ªÅ Thi</h2>
                            <div id="examListContainer"></div>
                        </div>
                    </div>
                </div>
            `;
        displayExamList();
      }

      function showCreateExamForm(folderId) {
        const folder =
          folders.find((f) => f.id === folderId) ||
          folders.find((f) => f.id === "default");
        if (!folder) return;

        currentFolderId = folderId;
        uploadedImages = [];

        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>‚ûï T·∫°o ƒê·ªÅ Thi M·ªõi</h1>
                        <p>L∆∞u trong th∆∞ m·ª•c: ${folder.name}</p>
                    </div>
                    <div class="nav-bar">
                        <button class="btn-logout" onclick="viewFolder('${folder.id}', '${folder.name}')">‚Üê Quay l·∫°i</button>
                    </div>
                    <div class="dashboard">
                        <div class="upload-section">
                            <h2 style="margin-bottom: 20px;">Th√¥ng tin ƒë·ªÅ thi</h2>
                            <div class="form-group">
                                <label>T√™n ƒë·ªÅ thi:</label>
                                <input type="text" id="examTitle" placeholder="VD: ƒê·ªÅ thi To√°n h·ªçc k·ª≥ 1">
                            </div>
                            <div class="form-group">
                                <label>ƒê√°p √°n (M·ªói d√≤ng m·ªôt c√¢u, v√≠ d·ª•: 1. A ho·∫∑c 3. C,D ho·∫∑c A):</label>
                                <textarea id="examAnswers" rows="5" placeholder="1. A&#10;2. B&#10;3. C,D&#10;..."></textarea>
                                <small style="color: #555;">**L∆∞u √Ω:** ƒê√°p √°n ƒë√∫ng cho m·ªói c√¢u, ph√¢n c√°ch ƒë√°p √°n ƒë√∫ng v·ªõi nhau b·∫±ng d·∫•u ph·∫©y (C,D).</small>
                            </div>
                            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                                <div style="font-size: 3em; margin-bottom: 10px;">üì§</div>
                                <h3>K√©o th·∫£ ·∫£nh c√¢u h·ªèi v√†o ƒë√¢y</h3>
                                <p style="margin-top: 10px; color: #666;">H·ªó tr·ª£ nhi·ªÅu ·∫£nh (JPG, PNG, GIF)</p>
                                <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFileUpload(event)">
                            </div>
                            <div id="previewArea" style="margin-top: 20px;"></div>
                            <button class="btn" style="margin-top: 20px;" onclick="saveExam()">üíæ L∆∞u ƒê·ªÅ Thi</button>
                        </div>
                    </div>
                </div>
            `;
        updatePreview();
      }

      let uploadedImages = [];

      function handleFileUpload(e) {
        const files = Array.from(e.target.files);

        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            uploadedImages.push(e.target.result);
            updatePreview();
          };
          reader.readAsDataURL(file);
        });
      }

      function updatePreview() {
        const previewArea = document.getElementById("previewArea");
        if (!previewArea) return;

        if (uploadedImages.length === 0) {
          previewArea.innerHTML = "";
          return;
        }

        previewArea.innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                    <strong>ƒê√£ t·∫£i l√™n ${uploadedImages.length} c√¢u h·ªèi</strong>
                    <button class="btn-small btn-delete" onclick="clearUploadedImages()" style="margin-left: 10px;">X√≥a</button>
                </div>
            `;
      }

      function clearUploadedImages() {
        uploadedImages = [];
        const fileInput = document.getElementById("fileInput");
        if (fileInput) fileInput.value = "";
        updatePreview();
      }

      function parseAnswers(answerText, numQuestions) {
        const lines = answerText
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0);

        const answers = {};
        let questionIndex = 1;

        for (const line of lines) {
          let match = line.match(/^(\d+)\.?\s*([A-Za-z,\s]+)$/);
          let qId = questionIndex;
          let ansStr;

          if (match) {
            qId = parseInt(match[1]);
            ansStr = match[2];
          } else {
            ansStr = line;
          }

          if (qId >= 1 && qId <= numQuestions) {
            answers[qId] = ansStr
              .toUpperCase()
              .replace(/\s/g, "")
              .split(",")
              .filter((a) => a.length > 0 && OPTIONS.includes(a));
          }
          questionIndex++;
        }

        if (Object.keys(answers).length === 0 && lines.length > 0) {
          for (let i = 0; i < lines.length && i < numQuestions; i++) {
            let ansStr = lines[i];
            answers[i + 1] = ansStr
              .toUpperCase()
              .replace(/\s/g, "")
              .split(",")
              .filter((a) => a.length > 0 && OPTIONS.includes(a));
          }
        }

        for (let i = 1; i <= numQuestions; i++) {
          if (!answers[i] || answers[i].length === 0) {
            answers[i] = null;
          }
        }

        return answers;
      }

      function saveExam() {
        const title = document.getElementById("examTitle").value.trim();
        const answerText = document.getElementById("examAnswers").value.trim();
        const numQuestions = uploadedImages.length;
        const folder =
          folders.find((f) => f.id === currentFolderId) ||
          folders.find((f) => f.id === "default");

        if (!title) {
          alert("Vui l√≤ng nh·∫≠p t√™n ƒë·ªÅ thi!");
          return;
        }

        if (numQuestions === 0) {
          alert("Vui l√≤ng upload √≠t nh·∫•t 1 c√¢u h·ªèi!");
          return;
        }

        if (!answerText) {
          alert("Vui l√≤ng nh·∫≠p ƒë√°p √°n cho ƒë·ªÅ thi!");
          return;
        }

        const correctAnswers = parseAnswers(answerText, numQuestions);
        const answeredCount = Object.keys(correctAnswers).filter(
          (id) => correctAnswers[id] !== null
        ).length;

        if (answeredCount < numQuestions) {
          if (
            !confirm(
              `B·∫°n ch·ªâ nh·∫≠p ƒë√°p √°n cho ${answeredCount}/${numQuestions} c√¢u h·ªèi. B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u ƒë·ªÅ thi?`
            )
          ) {
            return;
          }
        }

        const exam = {
          id: Date.now(),
          title: title,
          folderId: folder.id,
          questions: uploadedImages.map((img, index) => ({
            id: index + 1,
            image: img,
            correctAnswer: correctAnswers[index + 1] || null,
          })),
          createdAt: new Date().toLocaleString("vi-VN"),
        };

        exams.push(exam);
        saveExams();

        alert(`‚úÖ ƒê√£ l∆∞u ƒë·ªÅ thi "${title}" v√†o th∆∞ m·ª•c "${folder.name}"!`);

        viewFolder(folder.id, folder.name);
      }

      function displayExamList(searchTerm = "") {
        const container = document.getElementById("examListContainer");
        if (!container) return;

        const currentExams = exams
          .filter((e) => e.folderId === currentFolderId)
          .filter((e) =>
            e.title.toLowerCase().includes(searchTerm.toLowerCase())
          );

        if (currentExams.length === 0 && !searchTerm) {
          container.innerHTML =
            '<p style="text-align: center; color: #999; padding: 40px;">Ch∆∞a c√≥ ƒë·ªÅ thi n√†o trong th∆∞ m·ª•c n√†y.</p>';
          return;
        }

        if (currentExams.length === 0 && searchTerm) {
          container.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">Kh√¥ng t√¨m th·∫•y ƒë·ªÅ thi n√†o v·ªõi t·ª´ kh√≥a "${searchTerm}".</p>`;
          return;
        }

        container.innerHTML = currentExams
          .map(
            (exam) => `
                <div class="exam-card">
                    <h3>üìÑ ${exam.title}</h3>
                    <div class="exam-info">
                        <div>üìÖ Ng√†y t·∫°o: ${exam.createdAt}</div>
                        <div>üìù S·ªë c√¢u h·ªèi: ${exam.questions.length}</div>
                    </div>
                    <button class="btn-small btn-view" onclick="viewExamAdmin(${exam.id})">üëÅÔ∏è Xem</button>
                    <button class="btn-small btn-delete" onclick="deleteExam(${exam.id})">üóëÔ∏è X√≥a</button>
                </div>
            `
          )
          .join("");
      }

      function viewExamAdmin(examId) {
        const exam = exams.find((e) => e.id === examId);
        if (!exam) return;

        const folder =
          folders.find((f) => f.id === exam.folderId) ||
          folders.find((f) => f.id === "default");

        const answerHtml = exam.questions
          .map((q, index) => {
            const answer = q.correctAnswer
              ? q.correctAnswer.join(", ")
              : '<em style="color:#dc3545;">Ch∆∞a c√≥</em>';
            return `<p><strong>C√¢u ${index + 1}:</strong> ${answer}</p>`;
          })
          .join("");

        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>${exam.title}</h1>
                        <p>Trong th∆∞ m·ª•c: ${folder.name} | C√≥ ${
          exam.questions.length
        } c√¢u h·ªèi</p>
                    </div>
                    <div class="nav-bar">
                        <button class="btn-logout" onclick="viewFolder('${
                          folder.id
                        }', '${folder.name}')">‚Üê Quay l·∫°i</button>
                    </div>
                    <div class="dashboard">
                        <div style="margin-bottom: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                            <h2>üîë ƒê√°p √°n ƒë√∫ng</h2>
                            <div style="columns: 2; column-gap: 30px;">
                                ${answerHtml}
                            </div>
                        </div>
                    </div>
                    <div class="exam-display" style="padding-top: 0;">
                        <div class="question-container">
                            ${exam.questions
                              .map(
                                (q, index) => `
                                <div class="question-item">
                                    <div class="question-header">C√¢u ${
                                      index + 1
                                    }</div>
                                    <img src="${q.image}" alt="C√¢u ${
                                  index + 1
                                }" class="question-image">
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                </div>
            `;
      }

      function deleteExam(examId) {
        const exam = exams.find((e) => e.id === examId);
        if (!exam) return;

        const folder =
          folders.find((f) => f.id === exam.folderId) ||
          folders.find((f) => f.id === "default");

        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªÅ thi "${exam.title}"?`)) {
          exams = exams.filter((e) => e.id !== examId);
          saveExams();
          history = history.filter((h) => h.examId !== examId);
          saveHistory();

          viewFolder(folder.id, folder.name);
        }
      }

      // --- Student Management (Admin) ---

      function showStudentManagement() {
        currentView = "admin-students";
        const app = document.getElementById("app");

        const studentListHtml = students
          .map((student) => {
            const allowedFolderNames = student.allowedFolders
              .map((fid) => {
                const folder = folders.find((f) => f.id === fid);
                return folder ? folder.name : "Kh√¥ng t·ªìn t·∫°i";
              })
              .join(", ");

            return `
                <div class="exam-card" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3>üßë‚Äçüéì ${student.name}</h3>
                        <p><strong>ID:</strong> ${student.id}</p>
                        <p style="font-size: 0.9em; color: #555;"><strong>Quy·ªÅn truy c·∫≠p:</strong> ${
                          allowedFolderNames || "Kh√¥ng c√≥"
                        }</p>
                    </div>
                    <div>
                        <button class="btn-small btn-primary" onclick="showCreateStudentForm('${
                          student.id
                        }')">‚úèÔ∏è S·ª≠a</button>
                        <button class="btn-small btn-delete" onclick="deleteStudent('${
                          student.id
                        }')">üóëÔ∏è X√≥a</button>
                    </div>
                </div>
            `;
          })
          .join("");

        app.innerHTML = `
            <div class="container">
                <div class="header">
                    <h1>üßë‚Äçüéì Qu·∫£n L√Ω T√†i Kho·∫£n H·ªçc Sinh</h1>
                    <p>T·∫°o v√† c·∫•p quy·ªÅn truy c·∫≠p ƒë·ªÅ thi cho h·ªçc sinh</p>
                </div>
                <div class="nav-bar">
                    <button class="btn-logout" onclick="showAdminDashboard()">‚Üê V·ªÅ Dashboard</button>
                </div>
                <div class="dashboard">
                    <button class="btn-small btn-view" style="width: auto; margin-bottom: 20px;" onclick="showCreateStudentForm()">
                        ‚ûï Th√™m H·ªçc Sinh M·ªõi
                    </button>
                    
                    <h2 style="margin-bottom: 20px;">Danh S√°ch H·ªçc Sinh (${
                      students.length
                    })</h2>
                    <div class="student-list">
                        ${
                          studentListHtml ||
                          '<p style="text-align: center; color: #999; padding: 40px;">Ch∆∞a c√≥ t√†i kho·∫£n h·ªçc sinh n√†o.</p>'
                        }
                    </div>
                </div>
            </div>
        `;
      }

      function showCreateStudentForm(studentId = null) {
        const isEdit = studentId !== null;
        const studentToEdit = isEdit
          ? students.find((s) => s.id === studentId)
          : { name: "", id: "", allowedFolders: [] };

        const folderCheckboxes = folders
          .map((folder) => {
            const isChecked = studentToEdit.allowedFolders.includes(folder.id);
            return `
                <div style="margin-bottom: 8px;">
                    <input type="checkbox" id="folder_${folder.id}" value="${
              folder.id
            }" ${isChecked ? "checked" : ""} style="margin-right: 10px;">
                    <label for="folder_${folder.id}">${folder.name} (${
              exams.filter((e) => e.folderId === folder.id).length
            } ƒë·ªÅ)</label>
                </div>
            `;
          })
          .join("");

        const app = document.getElementById("app");
        app.innerHTML = `
            <div class="container">
                <div class="header">
                    <h1>${
                      isEdit
                        ? "‚úèÔ∏è S·ª≠a T√†i Kho·∫£n H·ªçc Sinh"
                        : "‚ûï T·∫°o T√†i Kho·∫£n H·ªçc Sinh"
                    }</h1>
                </div>
                <div class="nav-bar">
                    <button class="btn-logout" onclick="showStudentManagement()">‚Üê V·ªÅ Qu·∫£n L√Ω H·ªçc Sinh</button>
                </div>
                <div class="login-container">
                    <div class="login-box">
                        <h2 class="login-title">${
                          isEdit ? "S·ª≠a th√¥ng tin" : "T·∫°o m·ªõi"
                        }</h2>
                        <div id="errorMsg" class="error-message hidden"></div>
                        <form onsubmit="handleSaveStudent(event, ${
                          isEdit ? `'${studentId}'` : "null"
                        })">
                            <div class="form-group">
                                <label>H·ªç v√† t√™n:</label>
                                <input type="text" id="studentName" required value="${
                                  studentToEdit.name
                                }">
                            </div>
                            <div class="form-group">
                                <label>M√£/ID H·ªçc sinh (D√πng ƒë·ªÉ ƒëƒÉng nh·∫≠p, v√≠ d·ª•: 12345):</label>
                                <input type="text" id="studentId" required value="${
                                  studentToEdit.id
                                }" ${isEdit ? "readonly" : ""}>
                                ${
                                  isEdit
                                    ? '<small style="color: #dc3545;">*ID kh√¥ng th·ªÉ s·ª≠a</small>'
                                    : ""
                                }
                            </div>
                            <div class="form-group" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                                <label style="margin-bottom: 10px;"><strong>C·∫•p quy·ªÅn truy c·∫≠p th∆∞ m·ª•c:</strong></label>
                                ${folderCheckboxes}
                            </div>
                            <button type="submit" class="btn">${
                              isEdit ? "üíæ C·∫≠p Nh·∫≠t" : "‚ûï T·∫°o T√†i Kho·∫£n"
                            }</button>
                            <button type="button" class="btn btn-secondary" onclick="showStudentManagement()">H·ªßy</button>
                        </form>
                    </div>
                </div>
            </div>
        `;
      }

      function handleSaveStudent(e, oldId) {
        e.preventDefault();
        const name = document.getElementById("studentName").value.trim();
        const newId = document.getElementById("studentId").value.trim();
        const errorMsg = document.getElementById("errorMsg");

        const selectedFolders = folders
          .filter((folder) => {
            const checkbox = document.getElementById(`folder_${folder.id}`);
            return checkbox && checkbox.checked;
          })
          .map((f) => f.id);

        if (!name || !newId) {
          errorMsg.textContent = "Vui l√≤ng nh·∫≠p ƒë·ªß H·ªç t√™n v√† ID!";
          errorMsg.classList.remove("hidden");
          return;
        }

        if (oldId === null) {
          // Check if ID exists for new student
          if (students.some((s) => s.id === newId)) {
            errorMsg.textContent = `ID "${newId}" ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ch·ªçn ID kh√°c.`;
            errorMsg.classList.remove("hidden");
            return;
          }
          // Add new student
          students.push({
            name: name,
            id: newId,
            allowedFolders: selectedFolders,
          });
          alert(`‚úÖ ƒê√£ t·∫°o t√†i kho·∫£n h·ªçc sinh "${name}" (${newId})!`);
        } else {
          // Edit existing student
          const index = students.findIndex((s) => s.id === oldId);
          if (index > -1) {
            students[index].name = name;
            students[index].allowedFolders = selectedFolders;
            alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t t√†i kho·∫£n h·ªçc sinh "${name}" (${newId})!`);
          }
        }

        saveStudents();
        showStudentManagement();
      }

      function deleteStudent(studentId) {
        const student = students.find((s) => s.id === studentId);
        if (!student) return;

        if (
          confirm(
            `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n h·ªçc sinh "${student.name}" (ID: ${student.id})? T·∫•t c·∫£ l·ªãch s·ª≠ thi c·ªßa h·ªçc sinh n√†y s·∫Ω ƒë∆∞·ª£c gi·ªØ l·∫°i.`
          )
        ) {
          students = students.filter((s) => s.id !== studentId);
          saveStudents();
          showStudentManagement();
        }
      }

      function showAllHistoryAdmin() {
        currentView = "admin-all-history";
        const allHistory = history.sort((a, b) => b.timestamp - a.timestamp);

        const historyListHtml =
          allHistory
            .map((h) => {
              const exam = exams.find((e) => e.id === h.examId) || {
                title: "ƒê·ªÅ thi ƒë√£ b·ªã x√≥a",
                questions: [],
              };
              return `
                  <div class="history-card">
                      <div>
                          <p><strong>üìÑ ${exam.title}</strong></p>
                          <p>üßë‚Äçüéì ${h.studentName} (ID: ${h.studentId})</p>
                          <p style="font-size: 0.9em; color: #666;">üìÖ ${
                            h.date
                          }</p>
                      </div>
                      <div style="text-align: right;">
                          <p style="font-size: 1.2em; font-weight: bold; color: ${
                            h.score >= 5 ? "#28a745" : "#dc3545"
                          };">${h.score} / 10</p>
                          <p style="font-size: 0.9em; color: #666;">ƒê√∫ng: ${
                            h.correctCount
                          }/${h.totalQuestions}</p>
                          <button class="btn-small btn-primary" onclick="showReviewAdmin(${
                            h.id
                          })">Xem Chi Ti·∫øt</button>
                      </div>
                  </div>
              `;
            })
            .join("") ||
          '<p style="text-align: center; color: #999; padding: 40px;">Ch∆∞a c√≥ b√†i l√†m n√†o.</p>';

        const app = document.getElementById("app");
        app.innerHTML = `
              <div class="container">
                  <div class="header">
                      <h1>üìö To√†n B·ªô L·ªãch S·ª≠ Thi</h1>
                      <p>T·ªïng h·ª£p b√†i l√†m c·ªßa t·∫•t c·∫£ h·ªçc sinh</p>
                  </div>
                  <div class="nav-bar">
                      <button class="btn-logout" onclick="showAdminDashboard()">‚Üê V·ªÅ Dashboard</button>
                  </div>
                  <div class="dashboard">
                      <h2 style="margin-bottom: 20px;">C√°c B√†i ƒê√£ N·ªôp (${allHistory.length})</h2>
                      <div class="history-list">
                          ${historyListHtml}
                      </div>
                  </div>
              </div>
            `;
      }

      function showReviewAdmin(historyId) {
        const historyItem = history.find((h) => h.id === historyId);
        if (!historyItem) return;

        const exam = exams.find((e) => e.id === historyItem.examId);
        if (!exam) {
          alert("ƒê·ªÅ thi n√†y ƒë√£ b·ªã x√≥a!");
          return;
        }

        currentExam = exam;
        studentAnswers = historyItem.studentAnswers;

        // T√°i s·ª≠ d·ª•ng h√†m showResult v·ªõi isReviewMode = true
        showResult(
          historyItem.score,
          historyItem.correctCount,
          historyItem.incorrectCount,
          historyItem.unansweredCount,
          true,
          historyItem.studentName,
          "showAllHistoryAdmin" // N√∫t quay l·∫°i s·∫Ω v·ªÅ m√†n h√¨nh l·ªãch s·ª≠ Admin
        );
      }

      // --- Student Views ---

      function showStudentLogin() {
        currentView = "student-login";
        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>üë®‚Äçüéì Tham Gia Thi</h1>
                    </div>
                    <div class="student-login">
                        <div class="login-box">
                            <h2 class="login-title">ƒêƒÉng Nh·∫≠p H·ªçc Sinh</h2>
                            <div id="errorMsg" class="error-message hidden"></div>
                            <form onsubmit="handleStudentLogin(event)">
                                <div class="form-group">
                                    <label>H·ªç v√† t√™n:</label>
                                    <input type="text" id="studentName" required placeholder="Nguy·ªÖn VƒÉn A">
                                </div>
                                <div class="form-group">
                                    <label>M√£/ID H·ªçc sinh:</label>
                                    <input type="text" id="studentId" required placeholder="12345">
                                </div>
                                <button type="submit" class="btn">V√†o Thi</button>
                                <button type="button" class="btn btn-secondary" onclick="showHomePage()">Quay L·∫°i</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
      }

      function handleStudentLogin(e) {
        e.preventDefault();
        const name = document.getElementById("studentName").value.trim();
        const id = document.getElementById("studentId").value.trim();
        const errorMsg = document.getElementById("errorMsg");

        const student = students.find(
          (s) =>
            s.id.toUpperCase() === id.toUpperCase() &&
            s.name.toUpperCase() === name.toUpperCase()
        );

        if (!student) {
          errorMsg.textContent = "H·ªç t√™n ho·∫∑c M√£/ID h·ªçc sinh kh√¥ng ƒë√∫ng!";
          errorMsg.classList.remove("hidden");
          return;
        }

        if (student.allowedFolders.length === 0) {
          errorMsg.textContent =
            "B·∫°n ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn truy c·∫≠p ƒë·ªÅ thi n√†o. Vui l√≤ng li√™n h·ªá gi√°o vi√™n.";
          errorMsg.classList.remove("hidden");
          return;
        }

        currentStudent = student;
        showStudentFolderSelection();
      }

      function showStudentFolderSelection() {
        currentView = "student-folder-selection";
        if (!currentStudent) {
          showHomePage();
          return;
        }

        const app = document.getElementById("app");

        const historyCount = history.filter(
          (h) => h.studentId === currentStudent.id
        ).length;

        const allowedFolders = folders.filter((f) =>
          currentStudent.allowedFolders.includes(f.id)
        );

        const folderListHtml = allowedFolders
          .map((folder) => {
            const examCount = exams.filter(
              (e) => e.folderId === folder.id
            ).length;
            if (examCount === 0) return "";

            return `
                  <div class="folder-card" onclick="showExamSelection('${folder.id}', '${folder.name}')">
                      <h3>üìÇ ${folder.name}</h3>
                      <p style="font-size: 0.9em; color: #555;">(${examCount} ƒë·ªÅ thi)</p>
                  </div>
              `;
          })
          .join("");

        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>Ch·ªçn Th∆∞ M·ª•c ƒê·ªÅ Thi</h1>
                        <p>H·ªçc sinh: ${currentStudent.name} (ID: ${
          currentStudent.id
        })</p>
                    </div>
                    <div class="nav-bar">
                        <button class="btn-logout" onclick="showHomePage()">‚Üê ƒêƒÉng xu·∫•t</button>
                    </div>
                    <div class="dashboard">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <button class="btn btn-tertiary" style="width: auto;" onclick="showHistory()">
                                üìö Xem L·ªãch S·ª≠ Thi (${historyCount})
                            </button>
                        </div>
                        
                        <h2 style="margin-bottom: 20px;">üìö Danh S√°ch Th∆∞ M·ª•c C√≥ Th·ªÉ Thi</h2>
                        <div class="folder-container">
                            ${
                              folderListHtml ||
                              '<p style="text-align: center; color: #999; width: 100%; padding: 40px;">Hi·ªán ch∆∞a c√≥ ƒë·ªÅ thi n√†o trong c√°c th∆∞ m·ª•c b·∫°n ƒë∆∞·ª£c ph√©p truy c·∫≠p.</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
      }

      function showExamSelection(folderId, folderName, searchTerm = "") {
        currentView = "exam-selection";
        if (!currentStudent) {
          showHomePage();
          return;
        }

        const app = document.getElementById("app");

        const filteredExams = exams
          .filter((e) => e.folderId === folderId)
          .filter((e) =>
            e.title.toLowerCase().includes(searchTerm.toLowerCase())
          );

        const examListHtml = filteredExams
          .map((exam) => {
            return `
                      <div class="exam-card">
                          <h3>üìÑ ${exam.title}</h3>
                          <div class="exam-info">
                              <div>üìù S·ªë c√¢u h·ªèi: ${exam.questions.length}</div>
                              <div>üîë S·ªë c√¢u c√≥ ƒë√°p √°n: ${
                                exam.questions.filter((q) => q.correctAnswer)
                                  .length
                              }</div>
                          </div>
                          <button class="btn-small btn-view" onclick="startExam(${
                            exam.id
                          })">B·∫Øt ƒê·∫ßu Thi</button>
                      </div>
                  `;
          })
          .join("");

        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>Ch·ªçn ƒê·ªÅ Thi (${folderName})</h1>
                        <p>H·ªçc sinh: ${currentStudent.name}</p>
                    </div>
                    <div class="nav-bar">
                        <button class="btn-logout" onclick="showStudentFolderSelection()">‚Üê V·ªÅ Th∆∞ M·ª•c</button>
                    </div>
                    <div class="dashboard">
                        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
                            <div class="search-bar" style="width: 300px;">
                                <input type="text" id="studentSearch" placeholder="T√¨m ki·∫øm ƒë·ªÅ thi..." value="${searchTerm}" oninput="showExamSelection('${folderId}', '${folderName}', event.target.value)">
                            </div>
                        </div>
                        
                        <div class="exam-list">
                            ${
                              filteredExams.length > 0
                                ? examListHtml
                                : `<p style="text-align: center; color: #999; padding: 40px;">Kh√¥ng t√¨m th·∫•y ƒë·ªÅ thi n√†o ${
                                    searchTerm
                                      ? `v·ªõi t·ª´ kh√≥a "${searchTerm}"`
                                      : ""
                                  } trong th∆∞ m·ª•c n√†y.</p>`
                            }
                        </div>
                    </div>
                </div>
            `;
      }

      function showHistory() {
        currentView = "student-history";
        if (!currentStudent) {
          showHomePage();
          return;
        }

        const studentHistory = history
          .filter((h) => h.studentId === currentStudent.id)
          .sort((a, b) => b.timestamp - a.timestamp);

        const historyListHtml =
          studentHistory
            .map((h) => {
              const exam = exams.find((e) => e.id === h.examId) || {
                title: "ƒê·ªÅ thi ƒë√£ b·ªã x√≥a",
                questions: [],
              };
              return `
                  <div class="history-card">
                      <div>
                          <p><strong>üìÑ ${exam.title}</strong></p>
                          <p style="font-size: 0.9em; color: #666;">üìÖ ${
                            h.date
                          }</p>
                      </div>
                      <div style="text-align: right;">
                          <p style="font-size: 1.2em; font-weight: bold; color: ${
                            h.score >= 5 ? "#28a745" : "#dc3545"
                          };">${h.score} / 10</p>
                          <p style="font-size: 0.9em; color: #666;">ƒê√∫ng: ${
                            h.correctCount
                          }/${h.totalQuestions}</p>
                          <button class="btn-small btn-primary" onclick="showReview(${
                            h.id
                          })">Xem Chi Ti·∫øt</button>
                      </div>
                  </div>
              `;
            })
            .join("") ||
          '<p style="text-align: center; color: #999; padding: 40px;">Ch∆∞a c√≥ b√†i l√†m n√†o.</p>';

        const app = document.getElementById("app");
        app.innerHTML = `
              <div class="container">
                  <div class="header">
                      <h1>üìö L·ªãch S·ª≠ L√†m B√†i</h1>
                      <p>H·ªçc sinh: ${currentStudent.name}</p>
                  </div>
                  <div class="nav-bar">
                      <button class="btn-logout" onclick="showStudentFolderSelection()">‚Üê Quay l·∫°i</button>
                  </div>
                  <div class="dashboard">
                      <h2 style="margin-bottom: 20px;">C√°c B√†i ƒê√£ N·ªôp (${studentHistory.length})</h2>
                      <div class="history-list">
                          ${historyListHtml}
                      </div>
                  </div>
              </div>
            `;
      }

      function showReview(historyId) {
        const historyItem = history.find((h) => h.id === historyId);
        if (!historyItem) return;

        const exam = exams.find((e) => e.id === historyItem.examId);
        if (!exam) {
          alert("ƒê·ªÅ thi n√†y ƒë√£ b·ªã x√≥a!");
          return;
        }

        currentExam = exam;
        studentAnswers = historyItem.studentAnswers;

        showResult(
          historyItem.score,
          historyItem.correctCount,
          historyItem.incorrectCount,
          historyItem.unansweredCount,
          true,
          currentStudent.name,
          "showHistory" // N√∫t quay l·∫°i s·∫Ω v·ªÅ m√†n h√¨nh l·ªãch s·ª≠ h·ªçc sinh
        );
      }

      function startExam(examId) {
        currentView = "in-exam";
        if (!currentStudent) {
          showHomePage();
          return;
        }

        currentExam = exams.find((e) => e.id === examId);
        studentAnswers = {};

        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>${currentExam.title}</h1>
                        <p>H·ªçc sinh: ${currentStudent.name} | S·ªë c√¢u: ${
          currentExam.questions.length
        }</p>
                    </div>
                    <div class="exam-display">
                        <div class="question-container">
                            ${currentExam.questions
                              .map(
                                (q, index) => `
                                <div class="question-item">
                                    <div class="question-header">C√¢u ${
                                      index + 1
                                    }</div>
                                    <img src="${q.image}" alt="C√¢u ${
                                  index + 1
                                }" class="question-image">
                                    <div class="answer-section">
                                        <strong>Ch·ªçn ƒë√°p √°n:</strong>
                                        <div class="answer-options" id="q${
                                          index + 1
                                        }_options">
                                            ${OPTIONS.map(
                                              (opt) => `
                                                <div class="answer-option" onclick="selectAnswer(${
                                                  index + 1
                                                }, '${opt}')">
                                                    <input type="checkbox" name="q${
                                                      index + 1
                                                    }" value="${opt}" id="q${
                                                index + 1
                                              }_${opt}" onchange="updateMultiAnswer(${
                                                index + 1
                                              }, '${opt}', this.checked)">
                                                    <label for="q${
                                                      index + 1
                                                    }_${opt}">ƒê√°p √°n ${opt}</label>
                                                </div>
                                            `
                                            ).join("")}
                                        </div>
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <div class="submit-exam">
                            <button class="btn" onclick="submitExam()" style="padding: 15px 50px; font-size: 1.2em;">
                                ‚úÖ N·ªôp B√†i
                            </button>
                        </div>
                    </div>
                </div>
            `;
      }

      function updateMultiAnswer(questionId, answer, isChecked) {
        if (!studentAnswers[questionId]) {
          studentAnswers[questionId] = [];
        }

        const index = studentAnswers[questionId].indexOf(answer);

        if (isChecked && index === -1) {
          studentAnswers[questionId].push(answer);
        } else if (!isChecked && index > -1) {
          studentAnswers[questionId].splice(index, 1);
        }

        const optionsContainer = document
          .getElementById(`q${questionId}_options`)
          .querySelectorAll(".answer-option");
        optionsContainer.forEach((option) => {
          const input = option.querySelector("input");
          if (input.checked) {
            option.classList.add("selected");
          } else {
            option.classList.remove("selected");
          }
        });
      }

      function selectAnswer(questionId, answer) {
        const checkbox = document.getElementById(`q${questionId}_${answer}`);
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          updateMultiAnswer(questionId, answer, checkbox.checked);
        }
      }

      function submitExam() {
        if (!currentStudent) {
          showHomePage();
          return;
        }

        const totalQuestions = currentExam.questions.length;

        const answeredQuestions = Object.keys(studentAnswers).filter(
          (qId) => studentAnswers[qId] && studentAnswers[qId].length > 0
        ).length;

        if (answeredQuestions < totalQuestions) {
          if (
            !confirm(
              `B·∫°n m·ªõi l√†m ${answeredQuestions}/${totalQuestions} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?`
            )
          ) {
            return;
          }
        }

        let correctCount = 0;
        let incorrectCount = 0;

        const checkableQuestions = currentExam.questions.filter(
          (q) => q.correctAnswer && q.correctAnswer.length > 0
        );

        currentExam.questions.forEach((q) => {
          const studentAns = studentAnswers[q.id] || [];
          const correctAns = q.correctAnswer || [];

          if (correctAns.length === 0) {
            return;
          }

          if (studentAns.length === 0) {
            return;
          }

          const isCorrect =
            correctAns.length === studentAns.length &&
            correctAns.every((ans) => studentAns.includes(ans));

          if (isCorrect) {
            correctCount++;
          } else {
            incorrectCount++;
          }
        });

        const totalScore = 10;
        const scorePerQuestion =
          checkableQuestions.length > 0
            ? totalScore / checkableQuestions.length
            : 0;

        const finalScore = (correctCount * scorePerQuestion).toFixed(2);

        const unansweredCount = totalQuestions - correctCount - incorrectCount;

        const newHistoryItem = {
          id: Date.now(),
          examId: currentExam.id,
          studentName: currentStudent.name,
          studentId: currentStudent.id, // Th√™m studentId
          score: parseFloat(finalScore),
          correctCount: correctCount,
          incorrectCount: incorrectCount,
          unansweredCount: unansweredCount,
          totalQuestions: totalQuestions,
          date: new Date().toLocaleString("vi-VN"),
          timestamp: Date.now(),
          studentAnswers: { ...studentAnswers },
        };

        history.push(newHistoryItem);
        saveHistory();

        showResult(
          finalScore,
          correctCount,
          incorrectCount,
          unansweredCount,
          false,
          currentStudent.name,
          "showStudentFolderSelection" // N√∫t quay l·∫°i s·∫Ω v·ªÅ m√†n h√¨nh ch·ªçn th∆∞ m·ª•c
        );
      }

      function showResult(
        score,
        correct,
        incorrect,
        unanswered,
        isReviewMode,
        name,
        returnFunction
      ) {
        currentView = isReviewMode ? "review" : "result";

        const totalQuestions = currentExam.questions.length;

        const reviewHtml = currentExam.questions
          .map((q) => {
            const studentAns = studentAnswers[q.id] || [];
            const correctAns = q.correctAnswer || [];

            let status, statusClass;

            if (correctAns.length === 0) {
              status = "‚ö†Ô∏è GV ch∆∞a cung c·∫•p ƒë√°p √°n";
              statusClass = "review-unanswered";
            } else if (studentAns.length === 0) {
              status = "‚ùì Ch∆∞a tr·∫£ l·ªùi";
              statusClass = "review-unanswered";
            } else {
              const isCorrect =
                correctAns.length === studentAns.length &&
                correctAns.every((ans) => studentAns.includes(ans));
              if (isCorrect) {
                status = "‚úÖ ƒê√∫ng";
                statusClass = "review-correct";
              } else {
                status = "‚ùå Sai";
                statusClass = "review-incorrect";
              }
            }

            const studentAnsStr =
              studentAns.length > 0 ? studentAns.join(", ") : "Ch∆∞a tr·∫£ l·ªùi";
            const correctAnsStr =
              correctAns.length > 0 ? correctAns.join(", ") : "Kh√¥ng x√°c ƒë·ªãnh";

            return `
                  <div class="review-item ${statusClass}">
                      <div class="question-header" style="background: none; color: #333; padding: 0;"><strong>C√¢u ${
                        q.id
                      }: ${status}</strong></div>
                      <img src="${q.image}" alt="C√¢u ${
              q.id
            }" class="question-image" style="max-height: 250px; margin: 10px 0; border: 1px solid #ddd;">
                      <div class="review-info">
                          <p><strong>ƒê√°p √°n c·ªßa b·∫°n:</strong> <span style="font-weight: bold; color: ${
                            statusClass.includes("correct")
                              ? "#28a745"
                              : statusClass.includes("incorrect")
                              ? "#dc3545"
                              : "#ffc107"
                          };">${studentAnsStr}</span></p>
                          <p><strong>ƒê√°p √°n ƒë√∫ng:</strong> <span style="font-weight: bold; color: #667eea;">${correctAnsStr}</span></p>
                      </div>
                  </div>
              `;
          })
          .join("");

        let backButton;
        if (returnFunction === "showHistory") {
          backButton = `<button class="btn" onclick="showHistory()">V·ªÅ L·ªãch S·ª≠ Thi</button>`;
        } else if (returnFunction === "showAllHistoryAdmin") {
          backButton = `<button class="btn" onclick="showAllHistoryAdmin()">V·ªÅ L·ªãch S·ª≠ Thi Admin</button>`;
        } else {
          backButton = `<button class="btn" onclick="showHomePage()">V·ªÅ Trang Ch·ªß</button>`;
        }

        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>${
                          isReviewMode ? "üìñ Xem L·∫°i B√†i L√†m" : "‚≠ê K·∫øt Qu·∫£ Thi"
                        }</h1>
                    </div>
                    <div class="login-container">
                        <div class="login-box result-box">
                            <h2 style="color: #667eea; margin-bottom: 10px;">${
                              isReviewMode
                                ? "Chi Ti·∫øt B√†i L√†m"
                                : "üéâ Ch√∫c m·ª´ng " + name + "!"
                            }</h2>
                            <div style="font-size: 1.5em; color: #555;">ƒê·ªÅ thi: <strong>${
                              currentExam.title
                            }</strong></div>
                            
                            <div class="result-score">
                                ${score} / 10
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <div style="color: #28a745;">‚úÖ S·ªë c√¢u ƒë√∫ng: <strong>${correct}</strong></div>
                                <div style="color: #dc3545;">‚ùå S·ªë c√¢u sai: <strong>${incorrect}</strong></div>
                                <div style="color: #ffc107;">‚ùì S·ªë c√¢u ch∆∞a l√†m/ch∆∞a ch·∫•m: <strong>${unanswered}</strong></div>
                                <div style="color: #666;">üìù T·ªïng c√¢u h·ªèi: <strong>${totalQuestions}</strong></div>
                            </div>
                            
                            ${backButton}
                            ${
                              !isReviewMode
                                ? `<button class="btn btn-secondary" style="margin-top: 10px;" onclick="showReview(null, true)">Xem Chi Ti·∫øt B√†i L√†m</button>`
                                : ""
                            }
                        </div>
                    </div>
                    
                    <div class="dashboard">
                        <h2 style="margin-bottom: 20px;">Ph√¢n T√≠ch Chi Ti·∫øt T·ª´ng C√¢u</h2>
                        <div class="result-details">
                            ${reviewHtml}
                        </div>
                    </div>
                </div>
            `;
      }

      init();
    </script>
  </body>
</html>
